@using EDiary.ViewModels
@model JurnalModel 
<div class="jurnal__main col-12">
    @if (User.IsInRole("teacher"))
    {
        <div id="lessModal" class="modal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Добавить занятие</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form asp-controller="Marks" asp-action="AddLesson" method="post" enctype="multipart/form-data">
                        <div class="modal-body">
                            @foreach (var subject in Model.Subjects)
                            {
                                @if (subject.labaId == 0)
                                {
                                    <input asp-for="addLesson.id" type="hidden" readonly value="@subject.tsubjectId" />
                                    <input asp-for="addLesson.lessonType" type="text" list="lessTypes" required />
                                }
                                else
                                {
                                    <input asp-for="addLesson.labId" type="hidden" readonly value="@subject.labaId" />
                                }
                            }
                            <input asp-for="addLesson.lessonDate" type="datetime-local" required />
                            <datalist id="lessTypes">
                                @foreach (var type in Model.types)
                                {
                                    <option value="@type.typeName"></option>
                                }
                            </datalist>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" type="button" data-dismiss="modal">Отмена</button>
                            <input class="btn btn-primary" type="submit" value="Добавить" />
                        </div>
                    </form>
                </div>
            </div>
        </div>
    }
    <div class="card">
        <div class="card-body">
            <div class="table-editable sticky-table sticky-ltr-cells" id="table">
                <table class="editableTable table table-sm _table table-bordered table-responsive table-hover text-center m-0 overflow-auto">
                    <thead class="sticky-header"> 
                        <tr class="sticky-header">
                            <th></th>
                            @if (User.IsInRole("teacher"))
                            {
                                @foreach (var dateLesson in Model.Lessons)
                                {
                                    <th class="vt-text delLes" data-lessType="@dateLesson.lessonTypeId" data-idLess="@dateLesson.lessonId">@dateLesson.lessonDate.ToString("d")</th>
                                }
                            }
                            else
                            {
                                @foreach (var dateLesson in Model.Lessons)
                                {
                                    <th class="vt-text" data-lessType="@dateLesson.lessonTypeId" data-idLess="@dateLesson.lessonId">@dateLesson.lessonDate.ToString("d")</th>
                                }
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var student in Model.Students)
                        {
                            @if (student.studentId == ViewBag.studentId)
                            {
                                <tr class="currentStudent">
                                    @if (student.studentLastname != null)
                                    {
                                        <th data-idStud="@student.studentId" class="sticky-cell">@student.studentSurname @student.studentName.Substring(0, 1).@student.studentLastname.Substring(0, 1).</th>
                                    }
                                    else
                                    {
                                        <th data-idStud="@student.studentId" class="sticky-cell">@student.studentSurname @student.studentName.Substring(0, 1). </th>
                                    }

                                    @if (User.IsInRole("teacher"))
                                    {
                                        @foreach (var dateLesson in Model.Lessons)
                                        {
                                            var sm = Model.setMarks.Where(x => x.studentId == student.studentId && x.lessonId == dateLesson.lessonId).FirstOrDefault();
                                            if (sm != null)
                                            {
                                                <td class="pt-3-half" contenteditable="true" data-idsm="@sm.setmarkId" data-idLess="@dateLesson.lessonId" data-idStud="@student.studentId">@sm.mark.mark</td>
                                            }
                                            else
                                            {
                                                <td class="pt-3-half" contenteditable="true" data-idLess="@dateLesson.lessonId" data-idStud="@student.studentId"></td>
                                            }
                                        }
                                    }
                                    else
                                    {
                                        @foreach (var dateLesson in Model.Lessons)
                                        {
                                            var sm = Model.setMarks.Where(x => x.studentId == student.studentId && x.lessonId == dateLesson.lessonId).FirstOrDefault();
                                            if (sm != null)
                                            {
                                                <td data-idsm="@sm.setmarkId" data-idLess="@dateLesson.lessonId" data-idStud="@student.studentId">@sm.mark.mark</td>
                                            }
                                            else
                                            {
                                                <td data-idLess="@dateLesson.lessonId" data-idStud="@student.studentId"></td>
                                            }
                                        }
                                    }
                                </tr>
                            }
                            else
                            {
                                <tr>
                                    @if (student.studentLastname != null)
                                    {
                                        <th class="sticky-cell" data-idStud="@student.studentId">@student.studentSurname @student.studentName.Substring(0, 1).@student.studentLastname.Substring(0, 1).</th>
                                    }
                                    else
                                    {
                                        <th class="sticky-cell" data-idStud="@student.studentId">@student.studentSurname @student.studentName.Substring(0, 1).</th>
                                    }

                                    @if (User.IsInRole("teacher"))
                                    {
                                        @foreach (var dateLesson in Model.Lessons)
                                        {
                                            var sm = Model.setMarks.Where(x => x.studentId == student.studentId && x.lessonId == dateLesson.lessonId).FirstOrDefault();
                                            if (sm != null)
                                            {
                                                <td class="pt-3-half" data-idsm="@sm.setmarkId" data-idLess="@dateLesson.lessonId" data-idStud="@student.studentId" contenteditable="true">@sm.mark.mark</td>
                                            }
                                            else
                                            {
                                                <td class="pt-3-half" data-idLess="@dateLesson.lessonId" data-idStud="@student.studentId" contenteditable="true"></td>
                                            }
                                        }
                                    }
                                    else
                                    {
                                        @foreach (var dateLesson in Model.Lessons)
                                        {
                                            var sm = Model.setMarks.Where(x => x.studentId == student.studentId && x.lessonId == dateLesson.lessonId).FirstOrDefault();
                                            if (sm != null)
                                            {
                                                <td data-idsm="@sm.setmarkId" data-idLess="@dateLesson.lessonId" data-idStud="@student.studentId">@sm.mark.mark</td>
                                            }
                                            else
                                            {
                                                <td data-idLess="@dateLesson.lessonId" data-idStud="@student.studentId"></td>
                                            }
                                        }
                                    }
                                </tr>
                            }
                        }
                </tbody>
            </table>
            <div id="delLessModal" class="modal" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Удалить занятие</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <form asp-controller="Marks" asp-action="DeleteLesson" method="post" enctype="multipart/form-data">
                            <div class="modal-body">
                                @foreach (var subject in Model.Subjects)
                                {
                                    @if (subject.labaId == 0)
                                    {
                                        <input asp-for="deleteLesson.id" type="hidden" readonly value="@subject.tsubjectId" />
                                    }
                                    else
                                    {
                                        <input asp-for="deleteLesson.labId" type="hidden" readonly value="@subject.labaId" />
                                    }
                                }
                                <input id="idLess" asp-for="deleteLesson.lessonId" type="hidden" value="" />
                                <p id="delLabel">Удалить занятие </p>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" type="button" data-dismiss="modal">Отмена</button>
                                <input class="btn btn-primary" type="submit" value="Удалить" />
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
